<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2d3436">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pou: Ultimate Life</title>
    <style>
        /* =========================================
           1. RESET & CORE SETTINGS
           ========================================= */
        :root {
            --primary: #fdcb6e;
            --accent: #e17055;
            --ui-bg: rgba(255, 255, 255, 0.85);
            --ui-border: rgba(255, 255, 255, 0.4);
            --shadow-soft: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-hard: 0 5px 0 rgba(0,0,0,0.2);
            --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0; padding: 0;
            width: 100vw; 
            height: 100dvh; /* Dynamic Height for Mobile */
            overflow: hidden;
            font-family: var(--font);
            background: #222;
            touch-action: none;
        }

        /* =========================================
           2. ROOM BACKGROUNDS (PURE CSS ART)
           ========================================= */
        #world-track {
            display: flex;
            width: 500vw; height: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: transform;
        }

        .room {
            width: 100vw; height: 100%;
            position: relative;
            overflow: hidden;
        }

        /* 0: Bedroom (Yƒ±ldƒ±zlƒ± Duvar Kaƒüƒ±dƒ± + Halƒ±) */
        .room-0 {
            background-color: #6c5ce7;
            background-image: 
                radial-gradient(white 2px, transparent 2px),
                radial-gradient(rgba(255,255,255,.5) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            box-shadow: inset 0 -100px 100px rgba(0,0,0,0.2);
        }
        .room-0::after { /* Zemin */
            content: ''; position: absolute; bottom: 0; width: 100%; height: 30%;
            background: #a29bfe;
            border-top: 10px solid #5f27cd;
        }

        /* 1: Hall (Ah≈üap Parke + √áizgili Duvar) */
        .room-1 {
            background-color: #ffeaa7;
            background-image: linear-gradient(90deg, rgba(0,0,0,0.05) 50%, transparent 50%);
            background-size: 100px 100%;
        }
        .room-1::after { /* Parke Zemin */
            content: ''; position: absolute; bottom: 0; width: 100%; height: 25%;
            background: 
                linear-gradient(45deg, #e67e22 25%, transparent 25%, transparent 75%, #e67e22 75%, #e67e22),
                linear-gradient(45deg, #e67e22 25%, transparent 25%, transparent 75%, #e67e22 75%, #e67e22);
            background-color: #d35400;
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            border-top: 5px solid #8e44ad;
        }

        /* 2: Kitchen (Kareli Zemin + Mutfak Fayansƒ±) */
        .room-2 {
            background-color: #ff7675;
            background-image: 
                linear-gradient(rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px);
            background-size: 50px 50px;
        }
        .room-2::after { /* Checkerboard Zemin */
            content: ''; position: absolute; bottom: 0; width: 100%; height: 30%;
            background-image: 
                linear-gradient(45deg, #b2bec3 25%, transparent 25%), 
                linear-gradient(-45deg, #b2bec3 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #b2bec3 75%), 
                linear-gradient(-45deg, transparent 75%, #b2bec3 75%);
            background-size: 40px 40px;
            background-color: #fff;
            border-top: 8px solid #d63031;
        }

        /* 3: Bathroom (Mavi Fayanslar) */
        .room-3 {
            background-color: #74b9ff;
            background-image: 
                linear-gradient(335deg, rgba(255,255,255,0.1) 23px, transparent 23px),
                linear-gradient(155deg, rgba(255,255,255,0.1) 23px, transparent 23px),
                linear-gradient(335deg, rgba(255,255,255,0.1) 23px, transparent 23px),
                linear-gradient(155deg, rgba(255,255,255,0.1) 23px, transparent 23px);
            background-size: 58px 58px;
            background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;
        }
        .room-3::after { /* Parlak Zemin */
            content: ''; position: absolute; bottom: 0; width: 100%; height: 25%;
            background: linear-gradient(to bottom, #81ecec, #00cec9);
            border-top: 10px solid white;
        }

        /* 4: Game Room (Neon / Retro) */
        .room-4 {
            background: #2d3436;
            background-image: 
                linear-gradient(rgba(0, 255, 100, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 100, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .room-4::after {
            content: ''; position: absolute; bottom: 0; width: 100%; height: 25%;
            background: linear-gradient(to top, #000, #2d3436);
            border-top: 2px solid #00b894;
        }

        .room-label {
            position: absolute; top: 15%; width: 100%; text-align: center;
            font-size: 4rem; font-weight: 900; color: rgba(255,255,255,0.15);
            text-transform: uppercase; letter-spacing: 5px; pointer-events: none;
        }

        #night-overlay {
            position: absolute; width: 100%; height: 100%;
            background: rgba(10, 10, 40, 0.9);
            pointer-events: none; opacity: 0; transition: opacity 1s; z-index: 50;
        }

        /* =========================================
           3. CHARACTER
           ========================================= */
        #pou-container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -40%);
            width: 220px; height: 200px;
            z-index: 20;
            /* Dokunma olaylarƒ± i√ßin kritik: */
            touch-action: none; 
        }

        #pou-body {
            width: 100%; height: 100%;
            background: #e67e22; /* Default Color */
            border-radius: 50% 50% 40% 40%;
            position: relative;
            box-shadow: 
                inset -15px -15px 30px rgba(0,0,0,0.15), 
                inset 10px 10px 30px rgba(255,255,255,0.4),
                0 20px 40px rgba(0,0,0,0.3);
            display: flex; justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        #pou-body:active { transform: scale(0.95); }

        .eyes { display: flex; gap: 24px; position: absolute; top: 60px; z-index: 22; }
        .eye {
            width: 55px; height: 55px; background: #fff;
            border-radius: 50%; border: 4px solid #333;
            position: relative; overflow: hidden;
        }
        .pupil {
            width: 20px; height: 20px; background: #111;
            border-radius: 50%; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .lid {
            position: absolute; top: 0; width: 100%; height: 0%;
            background: inherit; z-index: 2; transition: height 0.1s; border-bottom: 2px solid #333;
        }

        .mouth {
            width: 40px; height: 15px;
            border-bottom: 5px solid #333; border-radius: 50%;
            position: absolute; top: 130px;
            transition: 0.2s;
        }
        .mouth.open { height: 35px; background: #5a2a2a; border-radius: 50%; border: 3px solid #333; }
        .mouth.sad { transform: rotate(180deg) translateY(-10px); }

        /* Kirler */
        .dirt {
            position: absolute; width: 40px; height: 40px;
            background: #4e342e; border-radius: 50%;
            opacity: 0.9; filter: blur(3px); z-index: 25;
            transition: all 0.3s;
        }
        .dirt.soaped {
            background: #fff; opacity: 0.8; 
            box-shadow: 0 0 10px #fff, inset 0 0 10px #ecf0f1;
            filter: blur(1px);
        }

        /* Kƒ±yafetler */
        .accessory { position: absolute; pointer-events: none; z-index: 30; }
        #wear-hat { top: -45px; font-size: 100px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); display: none; }
        #wear-glasses { top: 65px; font-size: 80px; display: none; }

        /* =========================================
           4. UI LAYOUT (MOBILE OPTIMIZED)
           ========================================= */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
        }

        /* Top HUD */
        .hud-top {
            position: absolute; top: 10px; left: 0; width: 100%;
            padding: 10px 20px;
            display: flex; justify-content: space-between;
            align-items: flex-start;
            pointer-events: auto;
        }

        .hud-left, .hud-right { display: flex; flex-direction: column; gap: 10px; }

        .badge {
            background: var(--ui-bg); backdrop-filter: blur(5px);
            padding: 8px 15px; border-radius: 20px;
            font-weight: 700; color: #444; border: 1px solid var(--ui-border);
            box-shadow: var(--shadow-soft); display: flex; align-items: center; gap: 5px;
        }

        /* Stat Bars Container - Centered Top */
        .stats-container {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.6); padding: 8px; border-radius: 12px;
            display: flex; gap: 6px; backdrop-filter: blur(5px);
        }
        .stat-bar { 
            width: 50px; height: 8px; background: rgba(0,0,0,0.1); 
            border-radius: 4px; overflow: hidden; position: relative; 
        }
        .stat-fill { height: 100%; width: 100%; transition: width 0.5s; }
        .stat-icon { position: absolute; top:-20px; left:50%; transform: translateX(-50%); font-size:12px; }

        /* Bottom Dock - Floating & Safe Area */
        .dock-container {
            position: absolute; 
            bottom: calc(20px + var(--safe-bottom)); 
            width: 100%;
            display: flex; justify-content: center;
            pointer-events: auto;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .dock-container.hidden { transform: translateY(150px); }

        .dock-scroll {
            display: flex; gap: 15px; 
            background: var(--ui-bg); padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid var(--ui-border);
            backdrop-filter: blur(10px);
            max-width: 90vw; overflow-x: auto; /* √áok e≈üya varsa kaydƒ±r */
        }

        .btn {
            width: 60px; height: 60px;
            background: #fff; border-radius: 18px;
            border: none; border-bottom: 4px solid #dfe6e9;
            font-size: 30px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: transform 0.1s;
            flex-shrink: 0; /* K√º√ß√ºlmesin */
        }
        .btn:active { transform: translateY(4px); border-bottom: 0; background: #eee; }
        .btn.active { background: #dff9fb; border-color: #81ecec; }

        /* Draggable Items */
        .drag-item {
            position: absolute; width: 60px; height: 60px;
            font-size: 50px; z-index: 200; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));
        }

        /* Toast */
        .toast {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%) scale(0.9);
            background: rgba(33, 33, 33, 0.95); color: white;
            padding: 10px 20px; border-radius: 30px; font-weight: bold;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 500;
        }
        .toast.show { transform: translateX(-50%) scale(1); opacity: 1; }

        /* Modals */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; }
        
        .modal-card {
            width: 90%; max-width: 400px; max-height: 80%;
            background: #fff; border-radius: 25px;
            display: flex; flex-direction: column;
            overflow: hidden; animation: popIn 0.3s;
        }
        @keyframes popIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }

        .modal-header { padding: 15px; background: #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9; }
        .close-btn { background: #ff7675; color: white; border:none; width:30px; height:30px; border-radius:50%; }

        /* Shop Grid */
        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .shop-item {
            background: white; padding: 10px; border-radius: 12px;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer; border: 2px solid transparent;
        }
        .shop-item:active { border-color: var(--primary); transform: scale(0.98); }
        .price { font-size: 12px; background: #fdcb6e; padding: 2px 6px; border-radius: 8px; margin-top: 5px; display: inline-block; }

        /* Canvas Game */
        canvas { width: 100%; height: 100%; }

    </style>
</head>
<body>

    <div id="viewport">
        <div id="night-overlay"></div>

        <div id="world-track">
            <div class="room room-0">
                <div class="room-label">Yatak Odasƒ±</div>
            </div>
            <div class="room room-1">
                <div class="room-label">Salon</div>
            </div>
            <div class="room room-2">
                <div class="room-label">Mutfak</div>
            </div>
            <div class="room room-3">
                <div class="room-label">Banyo</div>
            </div>
            <div class="room room-4">
                <div class="room-label">Oyun</div>
            </div>
        </div>

        <div id="pou-container">
            <div id="wear-hat" class="accessory">üé©</div>
            <div id="wear-glasses" class="accessory">üï∂Ô∏è</div>

            <div id="pou-body" onclick="Game.poke()">
                <div class="eyes">
                    <div class="eye"><div class="lid" id="lid-l"></div><div class="pupil" id="pupil-l"></div></div>
                    <div class="eye"><div class="lid" id="lid-r"></div><div class="pupil" id="pupil-r"></div></div>
                </div>
                <div class="mouth" id="mouth"></div>
            </div>
        </div>

        <div id="ui-layer">
            <div class="hud-top">
                <div class="badge">üí∞ <span id="ui-coin">0</span></div>
                <div class="badge" onclick="Game.save()">üíæ</div>
            </div>

            <div class="stats-container">
                <div class="stat-bar"><div class="stat-icon">üçñ</div><div class="stat-fill" id="bar-hunger" style="background:#ff7675;"></div></div>
                <div class="stat-bar"><div class="stat-icon">üßº</div><div class="stat-fill" id="bar-clean" style="background:#74b9ff;"></div></div>
                <div class="stat-bar"><div class="stat-icon">‚ö°</div><div class="stat-fill" id="bar-energy" style="background:#ffeaa7;"></div></div>
                <div class="stat-bar"><div class="stat-icon">üòä</div><div class="stat-fill" id="bar-fun" style="background:#a29bfe;"></div></div>
            </div>

            <div class="toast" id="toast">Mesaj</div>

            <div class="dock-container hidden" id="dock-0">
                <div class="dock-scroll">
                    <button class="btn" onclick="Game.toggleSleep()">üí°</button>
                    <button class="btn" onclick="Shop.open('clothes')">üëï</button>
                </div>
            </div>

            <div class="dock-container" id="dock-1">
                <div class="dock-scroll">
                    <div style="font-size:12px; color:#666; width:100px; text-align:center;">Kaydƒ±rmak i√ßin ekranƒ± s√ºr√ºkle</div>
                </div>
            </div>

            <div class="dock-container hidden" id="dock-2">
                <div class="dock-scroll" id="inventory-food">
                    <button class="btn" onclick="Shop.open('food')" style="border-color:#fab1a0; background:#fff5f5;">üõí</button>
                </div>
            </div>

            <div class="dock-container hidden" id="dock-3">
                <div class="dock-scroll">
                    <button class="btn" id="tool-sponge" ontouchstart="Interaction.startTool(event, 'sponge')" onmousedown="Interaction.startTool(event, 'sponge')">üßΩ</button>
                    <button class="btn" id="tool-shower" ontouchstart="Interaction.startTool(event, 'shower')" onmousedown="Interaction.startTool(event, 'shower')">üöø</button>
                </div>
            </div>

            <div class="dock-container hidden" id="dock-4">
                <div class="dock-scroll">
                    <button class="btn" onclick="MiniGames.start()">üéÆ</button>
                </div>
            </div>

        </div>
    </div>

    <div class="modal" id="modal-shop">
        <div class="modal-card">
            <div class="modal-header">
                <span>Market</span>
                <button class="close-btn" onclick="Shop.close()">‚úï</button>
            </div>
            <div style="padding:10px; display:flex; gap:10px; background:#fff;">
                <button onclick="Shop.render('food')" style="flex:1; padding:5px;">üçî Yiyecek</button>
                <button onclick="Shop.render('clothes')" style="flex:1; padding:5px;">üé© Kƒ±yafet</button>
                <button onclick="Shop.render('potion')" style="flex:1; padding:5px;">üß™ ƒ∞ksir</button>
            </div>
            <div class="modal-body">
                <div class="shop-grid" id="shop-content"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-game" style="background:#222;">
        <div style="width:100%; height:100%; position:relative;">
            <canvas id="game-canvas"></canvas>
            <button class="close-btn" style="position:absolute; top:20px; right:20px; width:40px; height:40px;" onclick="MiniGames.stop()">‚úï</button>
            <div id="game-score" style="position:absolute; top:20px; left:20px; color:white; font-size:24px; font-weight:bold;">0</div>
        </div>
    </div>

    <script>
        /* =========================================
           LOGIC: CONFIG & STATE
           ========================================= */
        const State = {
            coins: 200,
            stats: { hunger: 80, clean: 60, energy: 90, fun: 80 },
            inventory: ['üçé', 'üçï'],
            unlocked: [],
            equipped: { hat: null, glasses: null, color: '#e67e22' },
            currentRoom: 1, // 1: Hall
            isSleeping: false
        };

        const Config = {
            rooms: 5,
            items: {
                food: [
                    {id:'burger', icon:'üçî', price:15, fill:20},
                    {id:'donut', icon:'üç©', price:8, fill:10},
                    {id:'sushi', icon:'üç£', price:25, fill:30},
                    {id:'broccoli', icon:'ü•¶', price:5, fill:5},
                    {id:'chicken', icon:'üçó', price:12, fill:15}
                ],
                clothes: [
                    {id:'hat_top', icon:'üé©', price:100, type:'hat'},
                    {id:'hat_cap', icon:'üß¢', price:50, type:'hat'},
                    {id:'glasses_sun', icon:'üï∂Ô∏è', price:80, type:'glasses'}
                ],
                potion: [
                    {id:'pot_health', icon:'üß™', price:50, type:'heal', name:'Tam ≈ûifa'},
                    {id:'col_blue', icon:'üîµ', price:200, type:'color', val:'#74b9ff', name:'Mavi'},
                    {id:'col_pink', icon:'üü£', price:200, type:'color', val:'#a29bfe', name:'Mor'}
                ]
            }
        };

        /* =========================================
           LOGIC: GAME ENGINE
           ========================================= */
        const Game = {
            init: () => {
                Game.load();
                UI.renderStats();
                UI.renderInventory();
                Character.updateLook();
                UI.switchRoom(1);
                
                // Loops
                setInterval(Game.tick, 2000); // Stat decay
                setInterval(Character.blink, 4000); // G√∂z kƒ±rpma
                setInterval(Game.spawnDirt, 10000); // Kirlenme

                // Swipe Listener
                Interaction.initSwipe();
                Interaction.initEyes();
            },

            tick: () => {
                if(State.isSleeping) {
                    State.stats.energy = Math.min(100, State.stats.energy + 5);
                    State.stats.hunger = Math.max(0, State.stats.hunger - 0.5);
                } else {
                    State.stats.hunger = Math.max(0, State.stats.hunger - 1);
                    State.stats.clean = Math.max(0, State.stats.clean - 0.5);
                    State.stats.energy = Math.max(0, State.stats.energy - 0.5);
                    State.stats.fun = Math.max(0, State.stats.fun - 0.5);
                }
                UI.renderStats();
            },

            poke: () => {
                if(State.isSleeping) return;
                Character.jump();
                State.stats.fun = Math.min(100, State.stats.fun + 5);
                UI.renderStats();
            },

            toggleSleep: () => {
                State.isSleeping = !State.isSleeping;
                const overlay = document.getElementById('night-overlay');
                if(State.isSleeping) {
                    overlay.style.opacity = 1;
                    document.querySelectorAll('.lid').forEach(l => l.style.height = '100%');
                    UI.toast("ƒ∞yi geceler...");
                } else {
                    overlay.style.opacity = 0;
                    document.querySelectorAll('.lid').forEach(l => l.style.height = '0%');
                }
            },

            spawnDirt: () => {
                if(!State.isSleeping && Math.random() > 0.6) {
                    const dirt = document.createElement('div');
                    dirt.className = 'dirt';
                    // Pou'nun i√ßinde rastgele konum
                    dirt.style.left = (20 + Math.random() * 60) + '%';
                    dirt.style.top = (20 + Math.random() * 60) + '%';
                    document.getElementById('pou-body').appendChild(dirt);
                    State.stats.clean -= 5;
                    UI.renderStats();
                }
            },

            save: () => {
                localStorage.setItem('pou_ultimate_v2', JSON.stringify(State));
                UI.toast("Kayƒ±t Edildi!");
            },
            load: () => {
                const data = localStorage.getItem('pou_ultimate_v2');
                if(data) {
                    const saved = JSON.parse(data);
                    Object.assign(State, saved);
                }
            }
        };

        /* =========================================
           LOGIC: UI & ROOMS
           ========================================= */
        const UI = {
            renderStats: () => {
                document.getElementById('bar-hunger').style.width = State.stats.hunger + '%';
                document.getElementById('bar-clean').style.width = State.stats.clean + '%';
                document.getElementById('bar-energy').style.width = State.stats.energy + '%';
                document.getElementById('bar-fun').style.width = State.stats.fun + '%';
                document.getElementById('ui-coin').innerText = State.coins;

                // Aƒüƒ±z durumu
                const mouth = document.getElementById('mouth');
                if(State.stats.hunger < 20 || State.stats.clean < 20) mouth.classList.add('sad');
                else mouth.classList.remove('sad');
            },

            renderInventory: () => {
                const container = document.getElementById('inventory-food');
                // Temizle ama market butonunu koru
                const shopBtn = container.querySelector('button');
                container.innerHTML = '';
                
                State.inventory.forEach((item, index) => {
                    const btn = document.createElement('div');
                    btn.className = 'btn';
                    btn.innerText = item;
                    // Dokunmatik s√ºr√ºkleme
                    btn.addEventListener('touchstart', (e) => Interaction.startDrag(e, item, index));
                    btn.addEventListener('mousedown', (e) => Interaction.startDrag(e, item, index));
                    container.appendChild(btn);
                });
                container.appendChild(shopBtn);
            },

            switchRoom: (idx) => {
                if(idx < 0 || idx > 4) return;
                State.currentRoom = idx;
                document.getElementById('world-track').style.transform = `translateX(-${idx * 100}vw)`;
                
                // Docklarƒ± y√∂net
                document.querySelectorAll('.dock-container').forEach(d => d.classList.add('hidden'));
                const target = document.getElementById(`dock-${idx}`);
                if(target) setTimeout(() => target.classList.remove('hidden'), 200);
            },

            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'), 2000);
            }
        };

        /* =========================================
           LOGIC: INTERACTION (SWIPE, DRAG, TOOLS)
           ========================================= */
        const Interaction = {
            isDragging: false,
            
            initSwipe: () => {
                let startX = 0;
                const track = document.getElementById('world-track');
                
                document.addEventListener('touchstart', e => startX = e.touches[0].clientX, {passive:false});
                document.addEventListener('touchend', e => {
                    if(Interaction.isDragging) return; 
                    const diff = startX - e.changedTouches[0].clientX;
                    if(Math.abs(diff) > 50) {
                        if(diff > 0) UI.switchRoom(State.currentRoom + 1);
                        else UI.switchRoom(State.currentRoom - 1);
                    }
                }, {passive:false});
            },

            initEyes: () => {
                const move = (x, y) => {
                    if(State.isSleeping) return;
                    ['pupil-l', 'pupil-r'].forEach(id => {
                        const el = document.getElementById(id);
                        const rect = el.parentElement.getBoundingClientRect();
                        const cx = rect.left + rect.width/2;
                        const cy = rect.top + rect.height/2;
                        const angle = Math.atan2(y - cy, x - cx);
                        const dist = Math.min(5, Math.hypot(x-cx, y-cy)/10);
                        el.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                    });
                };
                window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
                window.addEventListener('touchmove', e => move(e.touches[0].clientX, e.touches[0].clientY));
            },

            // Yemek S√ºr√ºkleme
            startDrag: (e, itemIcon, index) => {
                e.preventDefault();
                Interaction.isDragging = true;
                
                const el = document.createElement('div');
                el.className = 'drag-item';
                el.innerText = itemIcon;
                document.body.appendChild(el);

                const move = (x, y) => {
                    el.style.left = (x - 30) + 'px';
                    el.style.top = (y - 30) + 'px';
                };
                
                const touch = e.touches ? e.touches[0] : e;
                move(touch.clientX, touch.clientY);

                const onMove = (ev) => {
                    const t = ev.touches ? ev.touches[0] : ev;
                    move(t.clientX, t.clientY);
                }

                const onEnd = (ev) => {
                    // Aƒüƒ±z √ßarpƒ±≈üma kontrol√º
                    const mouth = document.getElementById('mouth').getBoundingClientRect();
                    const item = el.getBoundingClientRect();
                    
                    if(item.left < mouth.right && item.right > mouth.left && 
                       item.top < mouth.bottom && item.bottom > mouth.top) {
                        Character.eat();
                        // Envanterden sil
                        State.inventory.splice(index, 1);
                        UI.renderInventory();
                    }

                    el.remove();
                    Interaction.isDragging = false;
                    window.removeEventListener('mousemove', onMove);
                    window.removeEventListener('touchmove', onMove);
                    window.removeEventListener('mouseup', onEnd);
                    window.removeEventListener('touchend', onEnd);
                }

                window.addEventListener('mousemove', onMove);
                window.addEventListener('touchmove', onMove, {passive:false});
                window.addEventListener('mouseup', onEnd);
                window.addEventListener('touchend', onEnd);
            },

            // Banyo Ara√ßlarƒ± (S√ºnger / Du≈ü)
            startTool: (e, type) => {
                e.preventDefault();
                Interaction.isDragging = true;
                const el = document.createElement('div');
                el.className = 'drag-item';
                el.innerText = type === 'sponge' ? 'üßΩ' : 'üöø';
                document.body.appendChild(el);

                const onMove = (ev) => {
                    const t = ev.touches ? ev.touches[0] : ev;
                    el.style.left = (t.clientX - 30) + 'px';
                    el.style.top = (t.clientY - 30) + 'px';

                    // √áarpƒ±≈üma ve Temizlik Mantƒ±ƒüƒ±
                    const pouRect = document.getElementById('pou-body').getBoundingClientRect();
                    // Sadece Pou √ºzerindeyken √ßalƒ±≈üsƒ±n
                    if(t.clientX > pouRect.left && t.clientX < pouRect.right && 
                       t.clientY > pouRect.top && t.clientY < pouRect.bottom) {
                        
                        document.querySelectorAll('.dirt').forEach(dirt => {
                            const r = dirt.getBoundingClientRect();
                            const dist = Math.hypot(t.clientX - (r.left + r.width/2), t.clientY - (r.top + r.height/2));
                            
                            if(dist < 50) {
                                if(type === 'sponge') {
                                    dirt.classList.add('soaped'); // K√∂p√ºrt
                                } else if(type === 'shower' && dirt.classList.contains('soaped')) {
                                    dirt.remove(); // Temizle
                                    State.stats.clean = Math.min(100, State.stats.clean + 10);
                                    State.coins += 2;
                                    UI.renderStats();
                                }
                            }
                        });
                    }
                }

                const onEnd = () => {
                    el.remove();
                    Interaction.isDragging = false;
                    window.removeEventListener('mousemove', onMove);
                    window.removeEventListener('touchmove', onMove);
                    window.removeEventListener('mouseup', onEnd);
                    window.removeEventListener('touchend', onEnd);
                }

                window.addEventListener('mousemove', onMove);
                window.addEventListener('touchmove', onMove, {passive:false});
                window.addEventListener('mouseup', onEnd);
                window.addEventListener('touchend', onEnd);
            }
        };

        /* =========================================
           LOGIC: CHARACTER ACTIONS
           ========================================= */
        const Character = {
            blink: () => {
                if(State.isSleeping) return;
                document.querySelectorAll('.lid').forEach(l => l.style.height = '100%');
                setTimeout(() => {
                    if(!State.isSleeping) document.querySelectorAll('.lid').forEach(l => l.style.height = '0%');
                }, 150);
            },
            jump: () => {
                const p = document.getElementById('pou-body');
                p.style.transform = "translateY(-30px) scale(0.95, 1.05)";
                setTimeout(() => p.style.transform = "translateY(0) scale(1)", 200);
            },
            eat: () => {
                const m = document.getElementById('mouth');
                m.classList.add('open');
                Character.jump();
                setTimeout(() => m.classList.remove('open'), 500);
                State.stats.hunger = Math.min(100, State.stats.hunger + 15);
                UI.renderStats();
            },
            updateLook: () => {
                // Renk
                document.getElementById('pou-body').style.background = State.equipped.color;
                // ≈ûapka
                const hat = document.getElementById('wear-hat');
                if(State.equipped.hat) {
                    const item = Config.items.clothes.find(i => i.id === State.equipped.hat);
                    hat.innerText = item.icon;
                    hat.style.display = 'block';
                } else hat.style.display = 'none';
                // G√∂zl√ºk
                const gls = document.getElementById('wear-glasses');
                if(State.equipped.glasses) {
                    const item = Config.items.clothes.find(i => i.id === State.equipped.glasses);
                    gls.innerText = item.icon;
                    gls.style.display = 'block';
                } else gls.style.display = 'none';
            }
        };

        /* =========================================
           LOGIC: SHOP
           ========================================= */
        const Shop = {
            open: (tab) => {
                document.getElementById('modal-shop').classList.add('active');
                Shop.render(tab);
            },
            close: () => {
                document.getElementById('modal-shop').classList.remove('active');
            },
            render: (category) => {
                const container = document.getElementById('shop-content');
                container.innerHTML = '';
                
                Config.items[category].forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'shop-item';
                    
                    const isOwned = State.unlocked.includes(item.id);
                    const label = (category === 'clothes' && isOwned) ? 'Sahipsin' : `${item.price}üí∞`;

                    div.innerHTML = `
                        <div style="font-size:30px;">${item.icon}</div>
                        <div style="font-weight:bold; font-size:14px;">${item.name || ''}</div>
                        <div class="price">${label}</div>
                    `;
                    div.onclick = () => Shop.buy(item, category);
                    container.appendChild(div);
                });
            },
            buy: (item, cat) => {
                if(cat === 'clothes' && State.unlocked.includes(item.id)) {
                    // Giy / √áƒ±kar
                    State.equipped[item.type] = (State.equipped[item.type] === item.id) ? null : item.id;
                    Character.updateLook();
                    UI.toast("Giyildi!");
                    return;
                }

                if(State.coins >= item.price) {
                    State.coins -= item.price;
                    UI.renderStats();

                    if(cat === 'food') {
                        State.inventory.push(item.icon);
                        UI.renderInventory();
                        UI.toast("Leziz!");
                    } else if (cat === 'clothes') {
                        State.unlocked.push(item.id);
                        Shop.render('clothes');
                        UI.toast("Alƒ±ndƒ±!");
                    } else if (cat === 'potion') {
                        if(item.type === 'heal') {
                            State.stats = {hunger:100, clean:100, energy:100, fun:100};
                            UI.renderStats();
                        } else if (item.type === 'color') {
                            State.equipped.color = item.val;
                            Character.updateLook();
                        }
                        UI.toast("Kullanƒ±ldƒ±!");
                    }
                } else {
                    UI.toast("Para yetersiz!");
                }
            }
        };

        /* =========================================
           LOGIC: MINI GAME (SKY JUMP)
           ========================================= */
        const MiniGames = {
            active: false,
            canvas: document.getElementById('game-canvas'),
            ctx: document.getElementById('game-canvas').getContext('2d'),
            score: 0,
            player: {}, platforms: [], loopId: null,

            start: () => {
                MiniGames.active = true;
                document.getElementById('modal-game').classList.add('active');
                
                const cvs = MiniGames.canvas;
                cvs.width = cvs.offsetWidth;
                cvs.height = cvs.offsetHeight;

                MiniGames.score = 0;
                MiniGames.player = { x: cvs.width/2, y: cvs.height-100, vy: -10, r: 15 };
                MiniGames.platforms = [];
                
                for(let i=0; i<8; i++) {
                    MiniGames.platforms.push({
                        x: Math.random() * (cvs.width-60),
                        y: cvs.height - (i*100), w: 60, h: 10
                    });
                }
                
                // Kontroller
                cvs.onclick = () => MiniGames.player.vy = -12;
                cvs.addEventListener('touchmove', e => {
                    e.preventDefault();
                    MiniGames.player.x = e.touches[0].clientX;
                }, {passive:false});

                MiniGames.loop();
            },

            stop: () => {
                MiniGames.active = false;
                cancelAnimationFrame(MiniGames.loopId);
                document.getElementById('modal-game').classList.remove('active');
                if(MiniGames.score > 0) {
                    const reward = Math.floor(MiniGames.score / 5);
                    State.coins += reward;
                    UI.toast(`Oyun Bitti! +${reward}üí∞`);
                    UI.renderStats();
                }
            },

            loop: () => {
                if(!MiniGames.active) return;
                const ctx = MiniGames.ctx;
                const p = MiniGames.player;
                const cvs = MiniGames.canvas;

                // Logic
                p.vy += 0.5;
                p.y += p.vy;

                // Kamera yukarƒ±
                if(p.y < cvs.height/2) {
                    p.y = cvs.height/2;
                    const diff = -p.vy;
                    MiniGames.score += diff/10;
                    MiniGames.platforms.forEach(pl => {
                        pl.y += diff;
                        if(pl.y > cvs.height) {
                            pl.y = -20;
                            pl.x = Math.random() * (cvs.width - 60);
                        }
                    });
                }

                // √áarpƒ±≈üma
                if(p.vy > 0) {
                    MiniGames.platforms.forEach(pl => {
                        if(p.x > pl.x && p.x < pl.x + pl.w && p.y + p.r > pl.y && p.y + p.r < pl.y + pl.h + 15) {
                            p.vy = -12;
                        }
                    });
                }

                if(p.y > cvs.height) { MiniGames.stop(); return; }

                // √áizim
                ctx.clearRect(0,0,cvs.width,cvs.height);
                
                ctx.fillStyle = '#00b894';
                MiniGames.platforms.forEach(pl => ctx.fillRect(pl.x, pl.y, pl.w, pl.h));

                ctx.fillStyle = State.equipped.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
                
                // G√∂zler
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(p.x-5, p.y-2, 5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(p.x+5, p.y-2, 5, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black';
                ctx.beginPath(); ctx.arc(p.x-5, p.y-2, 2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(p.x+5, p.y-2, 2, 0, Math.PI*2); ctx.fill();

                document.getElementById('game-score').innerText = Math.floor(MiniGames.score);
                MiniGames.loopId = requestAnimationFrame(MiniGames.loop);
            }
        };

        // Ba≈ülat
        window.onload = Game.init;

    </script>
</body>
</html>

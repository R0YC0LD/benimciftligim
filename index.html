<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2d3436">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pou: Ultimate Life v3</title>
    <style>
        /* =========================================
           1. CORE STYLES
           ========================================= */
        :root {
            --font: 'Segoe UI', system-ui, sans-serif;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0; width: 100vw; height: 100dvh;
            overflow: hidden; background: #222; font-family: var(--font);
            touch-action: none;
        }

        /* =========================================
           2. ROOMS & BACKGROUNDS
           ========================================= */
        #world-track {
            display: flex; width: 500vw; height: 100%;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .room {
            width: 100vw; height: 100%; position: relative;
            display: flex; flex-direction: column; align-items: center;
            border-right: 2px solid rgba(0,0,0,0.1);
        }

        /* ODA 0: YATAK ODASI (Mavi & Yƒ±ldƒ±zlar) */
        .room-0 {
            background-color: #6c5ce7;
            background-image: radial-gradient(white 2px, transparent 2px);
            background-size: 40px 40px;
        }
        .room-0::after { /* Zemin */
            content: ''; position: absolute; bottom: 0; width: 100%; height: 35%;
            background: #a29bfe; border-top: 15px solid #4834d4;
        }

        /* ODA 1: SALON (Sarƒ± & √áizgili) */
        .room-1 {
            background-color: #f1c40f;
            background-image: linear-gradient(90deg, rgba(255,255,255,0.3) 50%, transparent 50%);
            background-size: 60px 100%;
        }
        .room-1::after { /* Parke */
            content: ''; position: absolute; bottom: 0; width: 100%; height: 30%;
            background: #d35400; border-top: 15px solid #e67e22;
        }

        /* ODA 2: MUTFAK (Pembe & Kareli) */
        .room-2 {
            background-color: #ff7675;
            background-image: linear-gradient(rgba(255,255,255,0.3) 2px, transparent 2px),
                              linear-gradient(90deg, rgba(255,255,255,0.3) 2px, transparent 2px);
            background-size: 50px 50px;
        }
        .room-2::after { /* Fayans Zemin */
            content: ''; position: absolute; bottom: 0; width: 100%; height: 35%;
            background: #fff;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%), 
                              linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%);
            background-position: 0 0, 20px 20px; background-size: 40px 40px;
            border-top: 15px solid #d63031;
        }

        /* ODA 3: BANYO (Turkuaz Fayans) */
        .room-3 {
            background-color: #81ecec;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.3) 10px, rgba(255,255,255,0.3) 20px);
        }
        .room-3::after { /* Parlak Zemin */
            content: ''; position: absolute; bottom: 0; width: 100%; height: 30%;
            background: #00cec9; border-top: 15px solid #fff;
        }

        /* ODA 4: OYUN ODASI (Koyu & Neon) */
        .room-4 {
            background-color: #2d3436;
            background-image: radial-gradient(#00b894 3px, transparent 3px);
            background-size: 30px 30px;
        }
        .room-4::after {
            content: ''; position: absolute; bottom: 0; width: 100%; height: 30%;
            background: #000; border-top: 5px solid #00b894;
        }

        /* Oda Etiketleri */
        .room-tag {
            position: absolute; top: 120px; font-size: 3rem; font-weight: 900;
            color: rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 5px;
            pointer-events: none; width: 100%; text-align: center;
        }

        #night-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 30, 0.95); pointer-events: none; opacity: 0;
            transition: opacity 1s; z-index: 50;
        }

        /* =========================================
           3. POU CHARACTER
           ========================================= */
        #pou-wrapper {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%);
            width: 200px; height: 180px; z-index: 20; touch-action: none;
        }

        #pou {
            width: 100%; height: 100%;
            background: #e67e22;
            border-radius: 50% 50% 45% 45%;
            position: relative;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.2), 0 15px 25px rgba(0,0,0,0.3);
            display: flex; justify-content: center;
            transition: transform 0.1s;
        }
        #pou:active { transform: scale(0.95); }

        .eyes { display: flex; gap: 20px; position: absolute; top: 50px; z-index: 25; }
        .eye {
            width: 50px; height: 50px; background: white; border-radius: 50%;
            border: 4px solid #333; position: relative; overflow: hidden;
        }
        .pupil {
            width: 18px; height: 18px; background: black; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .lid {
            position: absolute; top: 0; left: 0; width: 100%; height: 0%;
            background: inherit; z-index: 2; transition: height 0.1s; border-bottom: 3px solid #333;
        }

        .mouth {
            width: 30px; height: 10px; border-bottom: 4px solid #333; border-radius: 50%;
            position: absolute; top: 115px; transition: 0.2s;
        }
        .mouth.open { height: 30px; background: #600; border: 3px solid #333; }
        .mouth.sad { transform: rotate(180deg) translateY(-10px); }

        /* Aksesuarlar */
        .acc { position: absolute; left: 50%; transform: translateX(-50%); pointer-events: none; z-index: 30; }
        #acc-hat { top: -50px; font-size: 80px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); }
        #acc-glasses { top: 55px; font-size: 70px; }

        /* Kaka */
        .poop {
            position: absolute; font-size: 50px; z-index: 15;
            animation: bounce 1s infinite; cursor: pointer;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
        }
        @keyframes bounce { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

        /* Kir */
        .dirt {
            position: absolute; width: 35px; height: 35px; background: #5d4037;
            border-radius: 50%; filter: blur(3px); z-index: 26;
        }
        .dirt.soaped { background: white; opacity: 0.8; }

        /* =========================================
           4. UI OVERLAY
           ========================================= */
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }

        /* Top HUD */
        .top-bar {
            position: absolute; top: 10px; width: 100%; padding: 0 15px;
            display: flex; justify-content: space-between; align-items: center; pointer-events: auto;
        }
        .badge {
            background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 20px;
            font-weight: bold; color: #444; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 5px; border: 2px solid #fff;
        }

        /* Stats */
        .stats {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.7); padding: 8px; border-radius: 15px;
            display: flex; gap: 8px; backdrop-filter: blur(5px); pointer-events: auto;
        }
        .stat-box { width: 45px; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; position: relative; }
        .stat-fill { height: 100%; width: 100%; transition: width 0.5s; }
        .stat-icon { position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 14px; }

        /* Bottom Dock */
        .dock {
            position: absolute; bottom: 30px; width: 100%; pointer-events: auto;
            display: flex; justify-content: center; transition: transform 0.3s;
        }
        .dock.hidden { transform: translateY(150px); }
        
        .dock-inner {
            background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 30px;
            display: flex; gap: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto; max-width: 95vw;
        }

        .btn {
            min-width: 60px; height: 60px; background: white; border-radius: 15px;
            border: none; border-bottom: 4px solid #ccc; font-size: 30px;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .btn:active { transform: translateY(4px); border-bottom: 0; background: #eee; }

        /* Draggable Food/Tools */
        .drag-obj {
            position: absolute; width: 60px; height: 60px; font-size: 50px;
            z-index: 200; pointer-events: none; display: flex; justify-content: center; align-items: center;
        }

        /* Toast */
        #toast {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px; border-radius: 20px;
            opacity: 0; transition: 0.3s; z-index: 500; font-weight: bold;
        }

        /* =========================================
           5. MODALS & GAMES
           ========================================= */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal.open { display: flex; }
        
        .card {
            width: 90%; max-width: 400px; height: 80%; background: #fff;
            border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;
            animation: pop 0.3s;
        }
        @keyframes pop { from{transform:scale(0.8);} to{transform:scale(1);} }

        .card-header { padding: 15px; background: #eee; display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem; }
        .card-body { flex: 1; overflow-y: auto; padding: 10px; background: #f5f5f5; }
        
        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .item { background: white; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .item.owned { border-color: #2ecc71; }
        .item:active { background: #eee; }

        .game-canvas { width: 100%; height: 100%; background: transparent; }
        .game-ui { position: absolute; top: 20px; left: 20px; color: white; font-size: 24px; font-weight: bold; text-shadow: 0 2px 5px black; pointer-events: none;}
        
    </style>
</head>
<body>

    <div id="night-mask"></div>

    <div id="world-track">
        <div class="room room-0"><div class="room-tag">Yatak Odasƒ±</div></div>
        <div class="room room-1"><div class="room-tag">Salon</div></div>
        <div class="room room-2"><div class="room-tag">Mutfak</div></div>
        <div class="room room-3"><div class="room-tag">Banyo</div></div>
        <div class="room room-4"><div class="room-tag">Oyun Odasƒ±</div></div>
    </div>

    <div id="pou-wrapper">
        <div class="acc" id="acc-hat"></div>
        <div class="acc" id="acc-glasses"></div>
        <div id="pou" onclick="Main.poke()">
            <div class="eyes">
                <div class="eye"><div class="lid" id="lid-l"></div><div class="pupil" id="p-l"></div></div>
                <div class="eye"><div class="lid" id="lid-r"></div><div class="pupil" id="p-r"></div></div>
            </div>
            <div class="mouth" id="mouth"></div>
        </div>
    </div>

    <div id="ui">
        <div class="top-bar">
            <div class="badge">ü™ô <span id="coin-disp">0</span></div>
            <div class="badge" onclick="Main.save()">üíæ Kaydet</div>
        </div>

        <div class="stats">
            <div class="stat-box"><div class="stat-icon">üçñ</div><div class="stat-fill" id="bar-hunger" style="background:#ff7675"></div></div>
            <div class="stat-box"><div class="stat-icon">üßº</div><div class="stat-fill" id="bar-clean" style="background:#74b9ff"></div></div>
            <div class="stat-box"><div class="stat-icon">‚ö°</div><div class="stat-fill" id="bar-energy" style="background:#ffeaa7"></div></div>
            <div class="stat-box"><div class="stat-icon">üòä</div><div class="stat-fill" id="bar-fun" style="background:#a29bfe"></div></div>
        </div>

        <div id="toast">Mesaj</div>

        <div class="dock hidden" id="dock-0">
            <div class="dock-inner">
                <button class="btn" onclick="Main.toggleSleep()">üí°</button>
                <button class="btn" onclick="Shop.open('clothes')">üëï</button>
                <button class="btn" onclick="Shop.open('wallpaper')">üñºÔ∏è</button>
            </div>
        </div>
        <div class="dock" id="dock-1">
            <div class="dock-inner"><small>Oda deƒüi≈ütirmek i√ßin kaydƒ±r</small></div>
        </div>
        <div class="dock hidden" id="dock-2">
            <div class="dock-inner" id="food-list">
                <button class="btn" onclick="Shop.open('food')">‚ûï</button>
            </div>
        </div>
        <div class="dock hidden" id="dock-3">
            <div class="dock-inner">
                <button class="btn" id="tool-sponge" onmousedown="Interact.start(event,'sponge')" ontouchstart="Interact.start(event,'sponge')">üßΩ</button>
                <button class="btn" id="tool-shower" onmousedown="Interact.start(event,'shower')" ontouchstart="Interact.start(event,'shower')">üöø</button>
                <button class="btn" onclick="Shop.open('potions')">üß™</button>
            </div>
        </div>
        <div class="dock hidden" id="dock-4">
            <div class="dock-inner">
                <button class="btn" onclick="Games.start('skyjump')">üöÄ Sky Jump</button>
                <button class="btn" onclick="Games.start('fooddrop')">üçé Food Drop</button>
                <button class="btn" onclick="Games.start('driver')">üèéÔ∏è Driver</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-shop">
        <div class="card">
            <div class="card-header"><span>Market</span><button onclick="Shop.close()">‚úï</button></div>
            <div style="padding:10px; display:flex; gap:5px; overflow-x:auto;">
                <button onclick="Shop.render('food')">üçî Yemek</button>
                <button onclick="Shop.render('clothes')">üß¢ Giyim</button>
                <button onclick="Shop.render('potions')">üß™ ƒ∞ksir</button>
            </div>
            <div class="card-body">
                <div class="shop-grid" id="shop-grid"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-game" style="background:#222;">
        <div style="position:relative; width:100%; height:100%;">
            <canvas class="game-canvas" id="game-cvs"></canvas>
            <div class="game-ui" id="game-score">0</div>
            <button style="position:absolute; top:20px; right:20px; font-size:30px; background:none; border:none; color:white;" onclick="Games.stop()">‚úï</button>
            <div id="game-controls" style="position:absolute; bottom:20px; width:100%; text-align:center; color:white; pointer-events:none;">Ekrana dokunarak oyna</div>
        </div>
    </div>

    <script>
        /* --- VERƒ∞LER VE AYARLAR --- */
        const DB = {
            items: {
                food: [
                    {id:'burger', name:'Burger', icon:'üçî', price:10, fill:25},
                    {id:'pizza', name:'Pizza', icon:'üçï', price:15, fill:30},
                    {id:'sushi', name:'Sushi', icon:'üç£', price:20, fill:20},
                    {id:'broccoli', name:'Brokoli', icon:'ü•¶', price:5, fill:10},
                    {id:'donut', name:'Donut', icon:'üç©', price:8, fill:15},
                    {id:'fries', name:'Patates', icon:'üçü', price:6, fill:12}
                ],
                clothes: [
                    {id:'hat_top', name:'Silindir', icon:'üé©', price:100, type:'hat'},
                    {id:'hat_cap', name:'≈ûapka', icon:'üß¢', price:50, type:'hat'},
                    {id:'hat_cowboy', name:'Kovboy', icon:'ü§†', price:150, type:'hat'},
                    {id:'gls_sun', name:'G√∂zl√ºk', icon:'üï∂Ô∏è', price:80, type:'glasses'},
                    {id:'gls_nerd', name:'Nerd', icon:'ü§ì', price:60, type:'glasses'}
                ],
                potions: [
                    {id:'pot_heal', name:'Tam ≈ûifa', icon:'‚ù§Ô∏è', price:50, type:'heal'},
                    {id:'pot_fat', name:'Zayƒ±flatƒ±cƒ±', icon:'üß™', price:30, type:'diet'},
                    {id:'col_blue', name:'Mavi', icon:'üîµ', price:200, type:'color', val:'#0984e3'},
                    {id:'col_pink', name:'Pembe', icon:'üü£', price:200, type:'color', val:'#e056fd'},
                    {id:'col_green', name:'Ye≈üil', icon:'üü¢', price:200, type:'color', val:'#badc58'}
                ]
            }
        };

        const State = {
            coins: 300,
            stats: { hunger: 80, clean: 60, energy: 90, fun: 80 },
            inventory: ['üçî', 'ü•¶'],
            unlocked: [],
            equipped: { hat: null, glasses: null, color: '#e67e22' },
            room: 1,
            sleep: false,
            poopCount: 0
        };

        /* --- ANA MOTOR --- */
        const Main = {
            init: () => {
                Main.load();
                UI.update();
                UI.renderFood();
                Main.loop();
                Interact.init();
            },
            loop: () => {
                // Zamanlayƒ±cƒ±lar
                setInterval(() => {
                    if(State.sleep) {
                        State.stats.energy = Math.min(100, State.stats.energy + 5);
                        State.stats.hunger = Math.max(0, State.stats.hunger - 0.5);
                    } else {
                        State.stats.hunger = Math.max(0, State.stats.hunger - 1);
                        State.stats.clean = Math.max(0, State.stats.clean - 0.5);
                        State.stats.energy = Math.max(0, State.stats.energy - 0.5);
                        State.stats.fun = Math.max(0, State.stats.fun - 0.5);
                    }
                    UI.update();
                }, 2000);

                // G√∂z Kƒ±rpma
                setInterval(() => {
                    if(!State.sleep) {
                        document.querySelectorAll('.lid').forEach(l => l.style.height = '100%');
                        setTimeout(() => document.querySelectorAll('.lid').forEach(l => l.style.height = '0%'), 150);
                    }
                }, 3500);

                // Kaka Olu≈üumu
                setInterval(() => {
                    if(!State.sleep && Math.random() > 0.7) Main.spawnPoop();
                }, 10000);
            },
            spawnPoop: () => {
                const p = document.createElement('div');
                p.className = 'poop';
                p.innerText = 'üí©';
                p.style.left = (Math.random() * 80 + 10) + 'vw';
                p.style.top = (Math.random() * 20 + 60) + 'vh'; // Yerde
                p.onclick = function() {
                    this.remove();
                    State.coins += 5;
                    UI.toast("+5 Altƒ±n");
                    UI.update();
                };
                // Kakayƒ± o anki odaya ekle
                document.querySelector(`.room-${State.room}`).appendChild(p);
            },
            spawnDirt: () => {
                const d = document.createElement('div');
                d.className = 'dirt';
                d.style.left = (20 + Math.random()*60) + '%';
                d.style.top = (20 + Math.random()*60) + '%';
                document.getElementById('pou').appendChild(d);
                State.stats.clean -= 5;
            },
            poke: () => {
                if(State.sleep) return;
                const p = document.getElementById('pou');
                p.style.transform = "scale(1.1, 0.9)";
                setTimeout(() => p.style.transform = "scale(1)", 150);
                State.stats.fun = Math.min(100, State.stats.fun + 5);
                UI.update();
            },
            toggleSleep: () => {
                State.sleep = !State.sleep;
                document.getElementById('night-mask').style.opacity = State.sleep ? 1 : 0;
                document.querySelectorAll('.lid').forEach(l => l.style.height = State.sleep ? '100%' : '0%');
            },
            save: () => { localStorage.setItem('pou_v3', JSON.stringify(State)); UI.toast("Kaydedildi"); },
            load: () => {
                const d = localStorage.getItem('pou_v3');
                if(d) Object.assign(State, JSON.parse(d));
                UI.applyLook();
                UI.switchRoom(1);
            }
        };

        /* --- ARAY√úZ --- */
        const UI = {
            update: () => {
                document.getElementById('bar-hunger').style.width = State.stats.hunger + '%';
                document.getElementById('bar-clean').style.width = State.stats.clean + '%';
                document.getElementById('bar-energy').style.width = State.stats.energy + '%';
                document.getElementById('bar-fun').style.width = State.stats.fun + '%';
                document.getElementById('coin-disp').innerText = State.coins;
                
                const mouth = document.getElementById('mouth');
                if(State.stats.hunger < 30 || State.stats.clean < 30) mouth.classList.add('sad');
                else mouth.classList.remove('sad');
            },
            renderFood: () => {
                const div = document.getElementById('food-list');
                const addBtn = div.firstElementChild; 
                div.innerHTML = '';
                State.inventory.forEach((icon, i) => {
                    const btn = document.createElement('div');
                    btn.className = 'btn';
                    btn.innerText = icon;
                    btn.ontouchstart = (e) => Interact.start(e, icon, i);
                    btn.onmousedown = (e) => Interact.start(e, icon, i);
                    div.appendChild(btn);
                });
                div.appendChild(addBtn);
            },
            applyLook: () => {
                document.getElementById('pou').style.background = State.equipped.color;
                document.getElementById('acc-hat').innerText = State.equipped.hat ? DB.items.clothes.find(x=>x.id==State.equipped.hat).icon : '';
                document.getElementById('acc-glasses').innerText = State.equipped.glasses ? DB.items.clothes.find(x=>x.id==State.equipped.glasses).icon : '';
            },
            switchRoom: (i) => {
                if(i<0 || i>4) return;
                State.room = i;
                document.getElementById('world-track').style.transform = `translateX(-${i*100}vw)`;
                document.querySelectorAll('.dock').forEach(d => d.classList.add('hidden'));
                const d = document.getElementById('dock-'+i);
                if(d) setTimeout(()=>d.classList.remove('hidden'), 300);
            },
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg; t.style.opacity = 1;
                setTimeout(()=>t.style.opacity=0, 2000);
            }
        };

        /* --- ETKƒ∞LE≈ûƒ∞M (S√úR√úKLEME) --- */
        const Interact = {
            drag: null,
            init: () => {
                // Oda Kaydƒ±rma
                let sx = 0;
                document.addEventListener('touchstart', e => sx = e.touches[0].clientX, {passive:false});
                document.addEventListener('touchend', e => {
                    if(Interact.drag || Games.active) return;
                    const diff = sx - e.changedTouches[0].clientX;
                    if(Math.abs(diff) > 50) UI.switchRoom(State.room + (diff>0?1:-1));
                }, {passive:false});

                // G√∂z Takibi
                const track = (x, y) => {
                    if(State.sleep) return;
                    ['p-l','p-r'].forEach(id => {
                        const el = document.getElementById(id);
                        const r = el.parentElement.getBoundingClientRect();
                        const cx = r.left+r.width/2, cy = r.top+r.height/2;
                        const ang = Math.atan2(y-cy, x-cx);
                        const dis = Math.min(6, Math.hypot(x-cx, y-cy)/8);
                        el.style.transform = `translate(-50%,-50%) translate(${Math.cos(ang)*dis}px, ${Math.sin(ang)*dis}px)`;
                    });
                };
                window.onmousemove = e => track(e.clientX, e.clientY);
                window.ontouchmove = e => track(e.touches[0].clientX, e.touches[0].clientY);
            },
            start: (e, type, idx) => {
                e.preventDefault();
                const d = document.createElement('div');
                d.className = 'drag-obj';
                d.innerText = (type=='sponge'?'üßΩ':type=='shower'?'üöø':type);
                document.body.appendChild(d);
                
                const move = (cx, cy) => {
                    d.style.left = (cx-30)+'px'; d.style.top = (cy-30)+'px';
                    
                    // Leke Temizleme
                    if(type=='sponge' || type=='shower') {
                        const pou = document.getElementById('pou').getBoundingClientRect();
                        if(cx > pou.left && cx < pou.right && cy > pou.top && cy < pou.bottom) {
                            document.querySelectorAll('.dirt').forEach(dirt => {
                                const r = dirt.getBoundingClientRect();
                                if(Math.hypot(cx-(r.left+17), cy-(r.top+17)) < 40) {
                                    if(type=='sponge') dirt.classList.add('soaped');
                                    else if(type=='shower' && dirt.classList.contains('soaped')) {
                                        dirt.remove();
                                        State.stats.clean = Math.min(100, State.stats.clean+10);
                                        State.coins++; UI.update();
                                    }
                                }
                            });
                        }
                    }
                };
                
                const up = (ev) => {
                    d.remove();
                    window.removeEventListener('touchmove', tm);
                    window.removeEventListener('touchend', up);
                    window.removeEventListener('mousemove', mm);
                    window.removeEventListener('mouseup', up);

                    // Yemek Yeme
                    const m = document.getElementById('mouth').getBoundingClientRect();
                    const r = d.getBoundingClientRect();
                    if(type!='sponge' && type!='shower' && 
                       r.left < m.right && r.right > m.left && r.top < m.bottom && r.bottom > m.top) {
                        // Animasyon
                        const p = document.getElementById('pou');
                        p.style.transform = "scale(1.1,0.9)"; setTimeout(()=>p.style.transform="scale(1)", 200);
                        document.getElementById('mouth').classList.add('open');
                        setTimeout(()=>document.getElementById('mouth').classList.remove('open'), 500);
                        
                        // Mantƒ±k
                        State.stats.hunger = Math.min(100, State.stats.hunger+20);
                        State.inventory.splice(idx, 1);
                        UI.renderFood(); UI.update();
                        
                        // Kaka ƒ∞htimali
                        if(Math.random() > 0.5) Main.spawnPoop();
                        if(Math.random() > 0.7) Main.spawnDirt();
                    }
                };

                const tm = ev => move(ev.touches[0].clientX, ev.touches[0].clientY);
                const mm = ev => move(ev.clientX, ev.clientY);

                window.addEventListener('touchmove', tm, {passive:false});
                window.addEventListener('touchend', up);
                window.addEventListener('mousemove', mm);
                window.addEventListener('mouseup', up);
                
                const t = e.touches ? e.touches[0] : e;
                move(t.clientX, t.clientY);
            }
        };

        /* --- MARKET --- */
        const Shop = {
            open: (cat) => {
                document.getElementById('modal-shop').classList.add('open');
                Shop.render(cat);
            },
            close: () => document.getElementById('modal-shop').classList.remove('open'),
            render: (cat) => {
                const g = document.getElementById('shop-grid'); g.innerHTML = '';
                DB.items[cat].forEach(i => {
                    const el = document.createElement('div');
                    el.className = 'item';
                    if(State.unlocked.includes(i.id)) el.classList.add('owned');
                    el.innerHTML = `<div style="font-size:30px">${i.icon}</div><div>${i.name}</div><div style="color:#e67e22;font-weight:bold">${State.unlocked.includes(i.id) ? 'Sahipsin' : i.price}</div>`;
                    el.onclick = () => Shop.buy(i, cat);
                    g.appendChild(el);
                });
            },
            buy: (item, cat) => {
                if(cat == 'clothes' && State.unlocked.includes(item.id)) {
                    State.equipped[item.type] = (State.equipped[item.type]==item.id ? null : item.id);
                    UI.applyLook(); return;
                }
                if(State.coins >= item.price) {
                    State.coins -= item.price;
                    if(cat == 'food') { State.inventory.push(item.icon); UI.renderFood(); UI.toast("Leziz!"); }
                    else if(cat == 'clothes') { State.unlocked.push(item.id); Shop.render(cat); UI.toast("Giyildi!"); }
                    else if(cat == 'potions') {
                        if(item.type=='heal') { State.stats.hunger=100; State.stats.clean=100; State.stats.energy=100; }
                        else if(item.type=='color') { State.equipped.color = item.val; UI.applyLook(); }
                        UI.toast("ƒ∞√ßildi!");
                    }
                    UI.update();
                } else UI.toast("Para Yetersiz!");
            }
        };

        /* --- OYUNLAR (CANVAS) --- */
        const Games = {
            active: false, ctx: null, cvs: null, loop: null,
            mode: '', score: 0, entities: [], player: {},
            
            start: (game) => {
                Games.active = true; Games.mode = game; Games.score = 0; Games.entities = [];
                const m = document.getElementById('modal-game'); m.style.display = 'block';
                const cvs = document.getElementById('game-cvs');
                cvs.width = window.innerWidth; cvs.height = window.innerHeight;
                Games.cvs = cvs; Games.ctx = cvs.getContext('2d');
                
                // Oyun Ba≈ülangƒ±√ß Ayarlarƒ±
                if(game == 'skyjump') {
                    Games.player = { x: cvs.width/2, y: cvs.height-150, vy: -10, r: 15 };
                    // D√ºzeltme: Ayaƒüƒ±nƒ±n altƒ±na platform koy
                    Games.entities.push({x: cvs.width/2 - 30, y: cvs.height-50, w:60, h:10});
                    for(let i=0; i<6; i++) Games.entities.push({x: Math.random()*(cvs.width-60), y:cvs.height - 150 - (i*120), w:60, h:10});
                } 
                else if(game == 'fooddrop') {
                    Games.player = { x: cvs.width/2, y: cvs.height-80, w: 50, h: 50 };
                }
                else if(game == 'driver') {
                    Games.player = { x: cvs.width/2, y: cvs.height-100, w: 40, h: 60 };
                }

                // Kontrol
                cvs.onclick = () => { if(game=='skyjump') Games.player.vy = -12; };
                cvs.ontouchmove = (e) => {
                    e.preventDefault();
                    Games.player.x = e.touches[0].clientX;
                };

                Games.tick();
            },
            stop: () => {
                Games.active = false; cancelAnimationFrame(Games.loop);
                document.getElementById('modal-game').style.display = 'none';
                if(Games.score > 0) {
                    const r = Math.ceil(Games.score / 10);
                    State.coins += r; UI.toast(`Oyun Bitti! +${r} Altƒ±n`); UI.update();
                }
            },
            tick: () => {
                if(!Games.active) return;
                const c = Games.ctx, w = Games.cvs.width, h = Games.cvs.height, p = Games.player;
                c.clearRect(0,0,w,h);

                /* --- SKY JUMP --- */
                if(Games.mode == 'skyjump') {
                    p.vy += 0.4; p.y += p.vy;
                    // Kamera Yukarƒ±
                    if(p.y < h/2) {
                        p.y = h/2; let diff = -p.vy; Games.score += diff;
                        Games.entities.forEach(e => {
                            e.y += diff;
                            if(e.y > h) { e.y = -20; e.x = Math.random()*(w-60); }
                        });
                    }
                    // Platform √áarpƒ±≈üma
                    if(p.vy > 0) Games.entities.forEach(e => {
                        if(p.x > e.x-10 && p.x < e.x+e.w+10 && p.y+p.r > e.y && p.y+p.r < e.y+20) p.vy = -13;
                    });
                    // √ñl√ºm
                    if(p.y > h) { Games.stop(); return; }
                    
                    // √áiz
                    c.fillStyle = '#2ecc71'; Games.entities.forEach(e => c.fillRect(e.x, e.y, e.w, e.h));
                    c.fillStyle = State.equipped.color; c.beginPath(); c.arc(p.x, p.y, p.r, 0, Math.PI*2); c.fill();
                }

                /* --- FOOD DROP --- */
                else if(Games.mode == 'fooddrop') {
                    if(Math.random() < 0.03) Games.entities.push({x:Math.random()*(w-30), y:-30, type:Math.random()>0.8?'üí£':'üçé'});
                    Games.entities.forEach((e, i) => {
                        e.y += 5;
                        c.font = "30px Arial"; c.fillText(e.type, e.x, e.y);
                        // √áarpƒ±≈üma
                        if(Math.hypot(p.x-e.x, p.y-e.y) < 40) {
                            if(e.type=='üí£') { Games.stop(); return; }
                            Games.score += 10; Games.entities.splice(i,1);
                        }
                    });
                    // Pou √áiz
                    c.fillStyle = State.equipped.color; c.fillRect(p.x-25, p.y-25, 50, 50);
                    // G√∂zler
                    c.fillStyle='white'; c.fillRect(p.x-15, p.y-15, 10,10); c.fillRect(p.x+5, p.y-15, 10,10);
                }

                /* --- DRIVER --- */
                else if(Games.mode == 'driver') {
                    Games.score += 1;
                    if(Games.score % 20 == 0) Games.entities.push({x:Math.random()*(w-50), y:-50, w:50, h:80});
                    Games.entities.forEach((e,i) => {
                        e.y += 8;
                        c.fillStyle = 'red'; c.fillRect(e.x, e.y, e.w, e.h);
                        if(p.x < e.x + e.w && p.x + p.w > e.x && p.y < e.y + e.h && p.h + p.y > e.y) { Games.stop(); return; }
                    });
                    c.fillStyle = 'blue'; c.fillRect(p.x, p.y, p.w, p.h);
                }

                document.getElementById('game-score').innerText = Math.floor(Games.score);
                Games.loop = requestAnimationFrame(Games.tick);
            }
        };

        window.onload = Main.init;
    </script>
</body>
</html>
